<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lace Archive</title>
  <style>
    :root { --gap: 16px; }
    html, body { margin:0; padding:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; color:#111; background:#fafafa; }
    header { max-width: 1100px; margin: 0 auto; padding: 24px 16px; }
    h1 { font-size: 1.8rem; margin: 0 0 8px; }
    .sub { color:#555; font-size: .95rem; }
    .bar { display:grid; grid-template-columns: 1fr repeat(5, minmax(140px, 180px)); gap:var(--gap); align-items:center; margin-top: 16px; }
    input[type="search"], select { padding:10px 12px; border:1px solid #ddd; border-radius:10px; background:#fff; }
    .count { grid-column: 1 / -1; color:#666; font-size:.9rem; text-align:right; }

    main { max-width: 1100px; margin: 0 auto; padding: 8px 16px 48px; }
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(260px,1fr)); gap: var(--gap); }

    .card { background:#fff; border:1px solid #eee; border-radius:16px; overflow:hidden; display:flex; flex-direction:column; }
    .thumb { aspect-ratio: 4 / 3; object-fit: cover; width:100%; background:#f1f1f1; }
    .body { padding:12px 14px 14px; display:flex; flex-direction:column; gap:6px; }
    .title { font-weight:600; }
    .meta { color:#666; font-size:.9rem; }
    .desc { color:#333; font-size:.95rem; }
    .tags { display:flex; flex-wrap:wrap; gap:6px; margin-top:6px; }
    .tag { font-size:.8rem; color:#444; background:#f3f3f3; border:1px solid #e8e8e8; padding:2px 8px; border-radius:999px; }

    .gallery { display:flex; gap:8px; overflow:auto; padding: 0 14px 14px; }
    .gallery img { height:80px; border-radius:10px; border:1px solid #eee; background:#f6f6f6; cursor: zoom-in; }

    .empty { text-align:center; color:#777; padding:40px 12px; }

    /* Lightbox */
    .lightbox { position:fixed; inset:0; background: rgba(0,0,0,.85); display:none; align-items:center; justify-content:center; z-index: 999; }
    .lightbox.open { display:flex; }
    .lightbox img { max-width: 92vw; max-height: 92vh; border-radius: 8px; }
    .lightbox .close { position:absolute; top:16px; right:16px; background:#fff; border:none; padding:8px 12px; border-radius:999px; cursor:pointer; }

    footer { max-width: 1100px; margin: 0 auto; padding: 16px; color:#777; font-size:.85rem; }
    .warn { color:#a45500; background:#fff7ed; border:1px solid #fed7aa; padding:10px 12px; border-radius:10px; }
  </style>
</head>
<body>
  <header>
    <h1>Lace Archive</h1>
    <div class="sub">Backed by your Google Sheet + Google Drive images.</div>
    <div class="bar">
      <input id="q" type="search" placeholder="Rechercher (titre, description, tags…)" />
      <select id="utilFilter"><option value="">Utilisation (toutes)</option></select>
      <select id="modeFilter"><option value="">Mode (tous)</option></select>
      <select id="epoFilter"><option value="">Époque (toutes)</option></select>
      <select id="styleFilter"><option value="">Style (tous)</option></select>
      <select id="fabFilter"><option value="">Fabrication (toutes)</option></select>
      <div class="count" id="count"></div>
    </div>
    <div id="heicNote" class="warn" style="display:none; margin-top:12px;">
      Vos images d'origine sont en <strong>.heic</strong>. La plupart des navigateurs ne l'affichent pas. Ajoutez des copies <strong>.jpg</strong> ou <strong>.webp</strong> et rafraîchissez l'index d'images dans le tableau.
    </div>
    <div id="status" class="sub" style="color:#6b7280;margin-top:6px;">Chargement des données…</div>
  </header>

  <main>
    <div id="grid" class="grid"></div>
    <div id="empty" class="empty" style="display:none;">Aucun résultat.</div>
  </main>

  <footer>
    <div>Les modifications du tableau et des images apparaissent au rechargement. Hébergez ce fichier via GitHub Pages.</div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    // ===================== CONFIG =====================
    // 1) Published CSV URL (specific tab)
    const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRlGOWOEaQVNHtM0uiGXtsJMcCJWrHztkeqM1kY2kgdHiwwVH3cpLJqhL7XxEuV1hn6QL5UQ-xMrRcS/pub?gid=0&single=true&output=csv";

    // 2) Google Drive: build a direct-view URL from a file ID
    const driveUrl = (id) => `https://drive.google.com/uc?export=view&id=${id}`;

    // 2b) Optional: filename-based fallback (if you later host on a CDN or in your repo)
    const IMAGE_BASE_URL = ""; // e.g., https://cdn.example.com/lace/
    const IMAGE_PRIORITY_EXTS = ["jpg","jpeg","webp","png"]; // add "heic" last only if you must
    const SUFFIXES = ["","A","B","C","D","E"]; // UID variants per piece

    // 3) Column mapping — EXACT header names from your sheet
    const COL = {
      ref: "UID",                       // e.g., 01, 01A
      title: "Description",             // short label shown as title
      description: "Description de l'ouvrage", // longer text
      year: "Epoque",                   // shown in the meta line
      type: "Style",                    // optional legacy mapping
      driveIds: "DriveIDs",             // semicolon/comma/newline-separated file IDs
      imageUrls: "ImageURLs",           // optional full URLs
      quantite: "Quantité",
      emplacement: "Emplacement",
      utilisation: "Utilisation",
      mode: "Mode",
      epoque: "Epoque",
      style: "Style",
      fabrication: "fabrication",
      client: "Client",
      collection: "Collection"
    };

    // Tag fields we want to show on cards (label : column)
    const TAG_FIELDS = [
      ["Quantité", COL.quantite],
      ["Emplacement", COL.emplacement],
      ["Utilisation", COL.utilisation],
      ["Mode", COL.mode],
      ["Époque", COL.epoque],
      ["Style", COL.style],
      ["Fabrication", COL.fabrication],
      ["Client", COL.client],
      ["Collection", COL.collection]
    ];

    // Filter fields and their select IDs
    const FILTERS = [
      { id: 'utilFilter', col: COL.utilisation },
      { id: 'modeFilter', col: COL.mode },
      { id: 'epoFilter', col: COL.epoque },
      { id: 'styleFilter', col: COL.style },
      { id: 'fabFilter', col: COL.fabrication },
    ];

    // ===================== HELPERS =====================
    function el(tag, attrs={}, children=[]) {
      const node = document.createElement(tag);
      for (const [k,v] of Object.entries(attrs)){
        if (k === 'class') node.className = v;
        else if (k === 'text') node.textContent = v;
        else if (k.startsWith('on') && typeof v === 'function') node[k.toLowerCase()] = v;
        else node.setAttribute(k, v);
      }
      for (const ch of [].concat(children)){
        if (typeof ch === 'string') node.appendChild(document.createTextNode(ch));
        else if (ch) node.appendChild(ch);
      }
      return node;
    }

    // Lightbox
    const lightbox = el('div', { class: 'lightbox', id: 'lightbox' }, [
      el('button', { class:'close', onclick: () => lightbox.classList.remove('open') }, ['Close'])
    ]);
    document.body.appendChild(lightbox);
    function openLightbox(src){
      const img = el('img', { src });
      lightbox.querySelectorAll('img').forEach(i => i.remove());
      lightbox.appendChild(img);
      lightbox.classList.add('open');
    }
    function shareRef(ref){
      try{
        const url = new URL(location.href);
        url.searchParams.set('ref', ref);
        if (navigator.clipboard && navigator.clipboard.writeText){
          navigator.clipboard.writeText(url.toString()).then(()=>{
            alert('Lien copié dans le presse‑papiers');
          }).catch(()=>{ window.prompt('Copier le lien :', url.toString()); });
        } else {
          window.prompt('Copier le lien :', url.toString());
        }
      } catch(e){ console.warn(e); }
    }

    function hydrateFilters(rows){
      // Build option sets for each filter
      FILTERS.forEach(f => {
        const set = new Set();
        rows.forEach(r => { if (r[f.col]) set.add(String(r[f.col]).trim()); });
        const sel = document.getElementById(f.id);
        [...set].sort((a,b)=>a.localeCompare(b)).forEach(v => sel.appendChild(el('option',{value:v, text:v})));
      });
    }

    function matchesQuery(row, q){
      if (!q) return true;
      const hayParts = [COL.title, COL.description, COL.ref, COL.year, COL.type, COL.utilisation, COL.mode, COL.epoque, COL.style, COL.fabrication, COL.quantite, COL.emplacement, COL.client, COL.collection];
      const hay = hayParts.map(c => (row[c]||'')+"").join(' ').toLowerCase();
      return hay.includes(q.toLowerCase());
    }

    function applyFilters(rows){
      const q = document.getElementById('q').value.trim();
      // Grab current filter values
      const active = {};
      FILTERS.forEach(f => { active[f.col] = document.getElementById(f.id).value; });

      return rows.filter(r => {
        if (!matchesQuery(r, q)) return false;
        // All dropdown filters must match if set
        for (const f of FILTERS){
          const want = document.getElementById(f.id).value;
          if (want && String(r[f.col]||'').trim() !== want) return false;
        }
        return true;
      });
    }

    function urlsFromRow(row){
      // 1) Drive IDs
      const driveRaw = row[COL.driveIds] || '';
      const driveIds = String(driveRaw).split(/[,;\n]+/).map(s=>s.trim()).filter(Boolean);
      if (driveIds.length) return driveIds.map(driveUrl);

      // 2) Direct URLs
      const urlRaw = row[COL.imageUrls] || '';
      const urls = String(urlRaw).split(/[,;\n]+/).map(s=>s.trim()).filter(Boolean);
      if (urls.length) return urls;

      // 3) Fallback: base URL + UID + suffixes + extensions
      const ref = row[COL.ref] ? String(row[COL.ref]).trim() : '';
      if (IMAGE_BASE_URL && ref){
        const candidates = [];
        for (const s of SUFFIXES){
          const name = ref + s;
          for (const ext of IMAGE_PRIORITY_EXTS){
            candidates.push(IMAGE_BASE_URL + name + '.' + ext);
          }
        }
        return candidates;
      }
      return [];
    }

    function render(rows){
      const grid = document.getElementById('grid');
      const empty = document.getElementById('empty');
      grid.innerHTML = '';
      const filtered = applyFilters(rows);
      document.getElementById('count').textContent = `${filtered.length} item${filtered.length===1?'':'s'}`;
      empty.style.display = filtered.length ? 'none' : 'block';

      filtered.forEach(r => {
        const ref = r[COL.ref] || '';
        const title = r[COL.title] || (ref ? `Item ${ref}` : 'Sans titre');
        const year = r[COL.year] || '';
        const desc = r[COL.description] || '';

        const urls = urlsFromRow(r);
        const gallery = el('div', { class:'gallery' });

        // Main image
        const topImg = el('img', { class:'thumb', loading:'lazy', alt:title });
        if (urls.length){
          topImg.src = urls[0];
          topImg.onclick = () => openLightbox(urls[0]);
          let i = 0; // fallback chain
          topImg.onerror = () => { i++; if (i < urls.length) topImg.src = urls[i]; else topImg.onerror = null; };
        } else {
          topImg.src = `data:image/svg+xml;charset=utf-8,${encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='1200' height='900'><rect width='100%' height='100%' fill='#f3f3f3'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='ui-sans-serif,system-ui' font-size='24' fill='#777'>Aucune image</text></svg>`)}`;
        }

        // Thumbnails (all URLs)
        urls.forEach(u => {
          const g = el('img', { loading:'lazy', alt: `${title}`, src: u });
          g.onclick = () => openLightbox(u);
          gallery.appendChild(g);
        });

        // Tags block
        const tags = TAG_FIELDS
          .map(([label, col]) => {
            const v = (r[col]||'').toString().trim();
            return v ? el('span', { class:'tag' }, [`${label}: ${v}`]) : null;
          })
          .filter(Boolean);

        const body = el('div', { class:'body' }, [
          el('div', { class:'title', text: title }),
          el('div', { class:'meta', text: [ref, year].filter(Boolean).join(' · ') }),
          desc ? el('div', { class:'desc', text: desc }) : null,
          tags.length ? el('div', { class:'tags' }, tags) : null
        ].filter(Boolean));

        const card = el('div', { class:'card', 'data-ref': ref }, [
          topImg,
          body,
          gallery,
          el('div', { class:'body' }, [
            el('a', { href:'#', class:'meta', onclick:(e)=>{ e.preventDefault(); shareRef(ref); } }, ['Partager le lien'])
          ])
        ]);
        grid.appendChild(card);
      });
    }

    function boot(rows){
      const usesHeicFirst = String(IMAGE_PRIORITY_EXTS[0] || '').toLowerCase() === 'heic';
      document.getElementById('heicNote').style.display = usesHeicFirst ? 'block' : 'none';

      hydrateFilters(rows);
      render(rows);

      // Deep-link support: ?ref=UID
      try {
        const params = new URLSearchParams(location.search);
        const urlRef = params.get('ref');
        if (urlRef) {
          const q = document.getElementById('q');
          if (q) q.value = urlRef;
          render(rows);
          const elCard = document.querySelector('.card[data-ref="' + urlRef + '"]');
          if (elCard) elCard.scrollIntoView({behavior:'smooth', block:'start'});
        }
      } catch(e) { /* noop */ }

      ['q','utilFilter','modeFilter','epoFilter','styleFilter','fabFilter']
        .forEach(id => document.getElementById(id).addEventListener('input', () => render(rows)));
    }

    // ===================== LOAD CSV =====================
    Papa.parse(SHEET_CSV_URL, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: function(res){
        const rows = res.data || [];
        const status = document.getElementById('status');
        if (status) status.textContent = `Lignes chargées : ${rows.length}`;
        boot(rows);
      },
      error: function(err){
        console.error(err);
        const s = document.getElementById('status');
        if (s) s.textContent = `Échec du chargement CSV (${err && err.message ? err.message : 'erreur inconnue'}). Vérifiez la publication et l'URL.`;
        document.getElementById('grid').innerHTML = '<div class="empty">Impossible de charger les données. Vérifiez l\'URL CSV / état de publication.</div>';
      }
    });
  </script>
</body>
</html>
