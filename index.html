<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Catalogue — Collection Le Berre-Pichavant</title>
  <meta name="description" content="Catalogue en ligne de la collection de dentelles Le Berre-Pichavant. Recherche, filtres, fiches et galerie images." />
  <!-- Tailwind via CDN (no build step) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PapaParse for robust CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    @media print {
      .no-print { display: none !important; }
      .print-only { display: block !important; }
      body { color: #000; }
    }
    .print-only { display: none; }
    .fade-in { animation: fade .25s ease-in; }
    @keyframes fade { from {opacity: 0;} to {opacity: 1;} }
    .thumbs::-webkit-scrollbar { height: 6px; }
    .thumbs::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 9999px; }
    :focus-visible { outline: 2px solid #2563eb; outline-offset: 2px; }
  </style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-900">
  <header class="sticky top-0 z-30 bg-white/90 backdrop-blur border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 py-4 flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between">
      <div>
        <h1 class="text-2xl font-semibold tracking-tight">Collection Le Berre-Pichavant</h1>
        <p class="text-slate-600 text-sm">Catalogue de dentelles — données Google Sheets, images Google Drive</p>
      </div>
      <div class="text-xs text-slate-500" id="statusLine">Chargement…</div>
    </div>
  </header>

  <section class="bg-white border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 py-4 grid gap-3 md:grid-cols-12">
      <div class="md:col-span-4">
        <label for="q" class="block text-xs font-medium text-slate-600">Recherche</label>
        <input id="q" type="search" placeholder="Rechercher titre, UID, description, étiquettes…" class="w-full mt-1 rounded-xl border border-slate-300 px-3 py-2 focus:ring-2 focus:ring-blue-500" />
      </div>
      <div class="md:col-span-8 grid grid-cols-2 md:grid-cols-5 gap-3">
        <div>
          <label class="block text-xs font-medium text-slate-600">Utilisation</label>
          <select id="f-utilisation" class="w-full mt-1 rounded-xl border border-slate-300 px-3 py-2">
            <option value="">Toutes</option>
          </select>
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600">Mode</label>
          <select id="f-mode" class="w-full mt-1 rounded-xl border border-slate-300 px-3 py-2">
            <option value="">Toutes</option>
          </select>
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600">Époque</label>
          <select id="f-epoque" class="w-full mt-1 rounded-xl border border-slate-300 px-3 py-2">
            <option value="">Toutes</option>
          </select>
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600">Style</label>
          <select id="f-style" class="w-full mt-1 rounded-xl border border-slate-300 px-3 py-2">
            <option value="">Tous</option>
          </select>
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600">Fabrication</label>
          <select id="f-fabrication" class="w-full mt-1 rounded-xl border border-slate-300 px-3 py-2">
            <option value="">Toutes</option>
          </select>
        </div>
      </div>
      <div class="md:col-span-12 flex gap-2">
        <button id="btn-reset" class="no-print inline-flex items-center gap-2 rounded-xl border border-slate-300 px-3 py-2 text-sm hover:bg-slate-50">Réinitialiser</button>
        <button id="btn-print" class="no-print inline-flex items-center gap-2 rounded-xl border border-slate-300 px-3 py-2 text-sm hover:bg-slate-50">Imprimer la fiche ouverte</button>
      </div>
    </div>
  </section>

  <main class="max-w-7xl mx-auto px-4 py-6">
    <div id="grid" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4"></div>
    <div id="emptyState" class="hidden text-center text-slate-500 py-16">Aucun résultat. Modifiez la recherche ou les filtres.</div>
  </main>

  <section id="detailPanel" class="hidden fixed inset-0 z-40 bg-white overflow-y-auto">
    <div class="max-w-5xl mx-auto px-4 py-6">
      <div class="flex items-start justify-between gap-4 no-print">
        <h2 id="detailTitle" class="text-xl font-semibold"></h2>
        <div class="flex gap-2">
          <button id="btnCloseDetail" class="rounded-xl border border-slate-300 px-3 py-2 text-sm hover:bg-slate-50">Fermer</button>
          <button onclick="window.print()" class="rounded-xl border border-slate-300 px-3 py-2 text-sm hover:bg-slate-50">Imprimer</button>
        </div>
      </div>
      <div id="detailContent" class="mt-4"></div>
    </div>
  </section>

  <div id="lightbox" class="hidden fixed inset-0 z-50 bg-black/90 text-white">
    <button id="lbClose" class="absolute top-4 right-4 px-3 py-1 rounded bg-white/10 hover:bg-white/20">Fermer</button>
    <button id="lbPrev" class="absolute left-3 top-1/2 -translate-y-1/2 px-3 py-2 rounded bg-white/10 hover:bg-white/20">&#10094;</button>
    <button id="lbNext" class="absolute right-3 top-1/2 -translate-y-1/2 px-3 py-2 rounded bg-white/10 hover:bg-white/20">&#10095;</button>
    <img id="lbImg" alt="" class="max-h-[90vh] max-w-[90vw] object-contain mx-auto my-8 fade-in" />
    <div id="lbCaption" class="text-center text-sm text-slate-200"></div>
  </div>

  <script>
    const DEFAULT_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRlGOWOEaQVNHtM0uiGXtsJMcCJWrHztkeqM1kY2kgdHiwwVH3cpLJqhL7XxEuV1hn6QL5UQ-xMrRcS/pub?output=csv";
    const urlParams = new URLSearchParams(location.search);
    const CSV_URL = urlParams.get('csv') || DEFAULT_CSV_URL;

    const FIELD_ALIASES = {
      uid: ["uid", "UID", "Uid", "Identifiant unique", "identifiant unique"],
      driveids: ["driveids", "DriveIDs", "Drive Ids", "Drive IDs", "Drive Id", "DriveId", "Images", "Image IDs", "Image Ids"],
      description: ["description", "Description"],
      longdesc: ["description de l'ouvrage", "Description de l'ouvrage", "Description de l’ouvrage", "longdesc"],
      epoque: ["epoque", "Époque", "Epoque"],
      utilisation: ["utilisation", "Utilisation"],
      mode: ["mode", "Mode"],
      style: ["style", "Style"],
      fabrication: ["fabrication", "Fabrication"],
      quantite: ["quantité", "Quantité", "Quantite"],
      emplacement: ["emplacement", "Emplacement"],
      client: ["client", "Client"],
      collection: ["collection", "Collection"],
      fileid: ["fileid", "FileId", "Drive FileId", "Drive File ID", "Drive File Id", "ID", "Id"],
      filename: ["filename", "Filename", "Fichier", "Nom", "Name"],
    };

    const REQUIRED_HEADERS = ["uid"];
    function keyOf(obj, wanted) {
      const list = FIELD_ALIASES[wanted] || [];
      return Object.keys(obj).find(k => list.includes(k));
    }
    function normalizeRow(row) {
      const out = {};
      for (const [k, v] of Object.entries(row || {})) {
        if (v === undefined || v === null) continue;
        out[k.trim()] = typeof v === 'string' ? v.trim() : v;
      }
      const lowered = {};
      Object.keys(out).forEach(k => lowered[k.toLowerCase()] = out[k]);
      return lowered;
    }
    function splitMulti(value) {
      if (!value) return [];
      return String(value).split(/\r?\n|;|,|\|/).map(s => s.trim()).filter(Boolean);
    }
    function normalizeDriveId(s) {
      if (!s) return null;
      const str = String(s).trim();
      let m = str.match(/[?&]id=([a-zA-Z0-9_-]+)/); if (m) return m[1];
      m = str.match(/\/d\/([a-zA-Z0-9_-]+)/); if (m) return m[1];
      m = str.match(/^([a-zA-Z0-9_-]{20,})$/); if (m) return m[1];
      return null;
    }
    function isHeaderLikeRow(r) {
      const kUID = keyOf(r, 'uid');
      const uid = (kUID && r[kUID]) ? String(r[kUID]).toLowerCase() : '';
      if (uid === 'uid' || uid === 'identifiant unique') return true;
      const kTitle = keyOf(r, 'description');
      const title = (kTitle && r[kTitle]) ? String(r[kTitle]).toLowerCase() : '';
      if (title === 'description') return true;
      return false;
    }
    function drivePreviewUrl(id) {
      return `https://drive.google.com/thumbnail?id=${encodeURIComponent(id)}&sz=w1000`;
    }
    function textOrDash(v) { return v ? String(v) : "—"; }

    let ITEMS = [];
    let IMAGE_MAP = {};

    function showError(e) {
      const el = document.createElement('div');
      el.className = 'fixed bottom-4 right-4 z-50 max-w-md bg-red-600 text-white text-sm rounded-lg shadow px-3 py-2';
      el.textContent = 'Erreur: ' + (e && e.message ? e.message : e);
      document.body.appendChild(el);
    }

    async function loadCSV() {
      const res = await fetch(CSV_URL, { cache: 'no-store' });
      if (!res.ok) throw new Error(`Échec de chargement CSV: ${res.status}`);
      const csvText = await res.text();
      return new Promise((resolve) => {
        Papa.parse(csvText, {
          header: true,
          skipEmptyLines: true,
          transformHeader: h => h,
          complete: (results) => resolve(results.data)
        });
      });
    }

    function collectSchemaWarnings(rows) {
      const first = rows[0] ? normalizeRow(rows[0]) : {};
      const missing = REQUIRED_HEADERS.filter(h => !keyOf(first, h));
      return missing;
    }

    function ingestRows(rows) {
      const items = new Map();
      const images = new Map();
      for (const raw of rows) {
        const r = normalizeRow(raw);
        const kUID = keyOf(r, 'uid');
        const uid = kUID ? r[kUID] : undefined;
        if (!uid) continue;
        if (isHeaderLikeRow(r)) continue;

        const kTitle = keyOf(r, 'description');
        const kLong = keyOf(r, 'longdesc');
        const kDrive = keyOf(r, 'driveids');
        const kFileId = keyOf(r, 'fileid');
        const kFilename = keyOf(r, 'filename');

        const imgArr = [];
        if (kDrive && r[kDrive]) {
          splitMulti(r[kDrive]).forEach(rawVal => {
            const id = normalizeDriveId(rawVal);
            if (id) imgArr.push({ id, filename: r[kFilename] || undefined });
          });
        }
        if (kFileId && r[kFileId]) {
          splitMulti(r[kFileId]).forEach(rawVal => {
            const id = normalizeDriveId(rawVal);
            if (id) imgArr.push({ id, filename: r[kFilename] || undefined });
          });
        }
        if (imgArr.length) {
          if (!images.has(uid)) images.set(uid, []);
          images.get(uid).push(...imgArr);
        }

        if (kTitle || kLong) {
          const item = items.get(uid) || { uid };
          item.title = (kTitle && r[kTitle]) || item.title || uid;
          item.long = (kLong && r[kLong]) || item.long || "";
          const kEpoque = keyOf(r, 'epoque');
          const kUtil = keyOf(r, 'utilisation');
          const kMode = keyOf(r, 'mode');
          const kStyle = keyOf(r, 'style');
          const kFab = keyOf(r, 'fabrication');
          item.epoque = kEpoque ? r[kEpoque] : (item.epoque || "");
          item.utilisation = kUtil ? r[kUtil] : (item.utilisation || "");
          item.mode = kMode ? r[kMode] : (item.mode || "");
          item.style = kStyle ? r[kStyle] : (item.style || "");
          item.fabrication = kFab ? r[kFab] : (item.fabrication || "");
          const kQ = keyOf(r, 'quantite');
          const kE = keyOf(r, 'emplacement');
          const kC = keyOf(r, 'client');
          const kCol = keyOf(r, 'collection');
          item.extra = {
            Quantité: kQ ? r[kQ] : undefined,
            Emplacement: kE ? r[kE] : undefined,
            Client: kC ? r[kC] : undefined,
            Collection: kCol ? r[kCol] : undefined,
          };
          items.set(uid, item);
        }
      }

      const out = [];
      let withImages = 0;
      items.forEach((item, uid) => {
        let arr = images.get(uid) || [];
        const seen = new Set();
        arr = arr.filter(x => {
          if (!x || !x.id) return false;
          if (seen.has(x.id)) return false;
          seen.add(x.id); return true;
        });
        const pref = (fn) => {
          const f = (fn || '').toString().toLowerCase();
          if (f.endsWith('.webp')) return 0;
          if (f.endsWith('.jpg') || f.endsWith('.jpeg')) return 1;
          if (f.endsWith('.png')) return 2;
          return 3;
        };
        // 🔹 NEW SORT: prefer extension priority, then alphabetical
        arr.sort((a, b) => {
          const pa = pref(a.filename);
          const pb = pref(b.filename);
          if (pa !== pb) return pa - pb;
          return (a.filename || '').localeCompare(b.filename || '', 'fr', { numeric: true });
        });
        item.images = arr;
        if (item.images.length) withImages++;
        out.push(item);
      });

      IMAGE_MAP = Object.fromEntries(images);
      ITEMS = out;
      return { countRows: rows.length, items: out, withImages };
    }

    function buildFilterOptions(items) {
      const pick = (k) => Array.from(new Set(items.map(it => (it[k] || '').trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b, 'fr'));
      fillSelect('f-utilisation', pick('utilisation'));
      fillSelect('f-mode', pick('mode'));
      fillSelect('f-epoque', pick('epoque'));
      fillSelect('f-style', pick('style'));
      fillSelect('f-fabrication', pick('fabrication'));
    }
    function fillSelect(id, values) {
      const sel = document.getElementById(id);
      const labelAll = id === 'f-style' ? 'Tous' : 'Toutes';
      const current = sel.value;
      sel.innerHTML = `<option value="">${labelAll}</option>`;
      values.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v; opt.textContent = v;
        sel.appendChild(opt);
      });
      if (values.includes(current)) sel.value = current;
    }

    function matchFilters(item) {
      const f = {
        utilisation: document.getElementById('f-utilisation').value,
        mode: document.getElementById('f-mode').value,
        epoque: document.getElementById('f-epoque').value,
        style: document.getElementById('f-style').value,
        fabrication: document.getElement
