<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Catalogue — Collection Le Berre-Pichavant</title>
  <meta name="description" content="Catalogue en ligne de la collection de dentelles Le Berre-Pichavant. Recherche, filtres, fiches et galerie images." />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    @media print {
      .no-print { display: none !important; }
      .print-only { display: block !important; }
      body { color: #000; }
    }
    .print-only { display: none; }
    .fade-in { animation: fade .25s ease-in; }
    @keyframes fade { from {opacity: 0;} to {opacity: 1;} }
    .thumbs::-webkit-scrollbar { height: 6px; }
    .thumbs::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 9999px; }
    :focus-visible { outline: 2px solid #2563eb; outline-offset: 2px; }
  </style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-900">
  <!-- header, filters, grid, detail panel, lightbox unchanged -->
  <!-- ... (your HTML layout from before goes here) ... -->

  <script>
    const DEFAULT_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRlGOWOEaQVNHtM0uiGXtsJMcCJWrHztkeqM1kY2kgdHiwwVH3cpLJqhL7XxEuV1hn6QL5UQ-xMrRcS/pub?output=csv";
    const urlParams = new URLSearchParams(location.search);
    const CSV_URL = urlParams.get('csv') || DEFAULT_CSV_URL;

    const FIELD_ALIASES = { /* your existing alias object here */ };
    const REQUIRED_HEADERS = ["uid"];

    function keyOf(obj, wanted) {
      const list = FIELD_ALIASES[wanted] || [];
      return Object.keys(obj).find(k => list.includes(k));
    }
    function normalizeRow(row) {
      const out = {};
      for (const [k, v] of Object.entries(row || {})) {
        if (v === undefined || v === null) continue;
        out[k.trim()] = typeof v === 'string' ? v.trim() : v;
      }
      const lowered = {};
      Object.keys(out).forEach(k => lowered[k.toLowerCase()] = out[k]);
      return lowered;
    }
    function splitMulti(value) {
      if (!value) return [];
      return String(value)
        .split(/\n|;|,|\|/) // FIXED regex
        .map(s => s.trim())
        .filter(Boolean);
    }
    function normalizeDriveId(s) { /* unchanged */ }
    function isHeaderLikeRow(r) { /* unchanged */ }
    function drivePreviewUrl(id) { return `https://drive.google.com/thumbnail?id=${encodeURIComponent(id)}&sz=w1000`; }
    function textOrDash(v) { return v ? String(v) : "—"; }

    let ITEMS = [];
    let IMAGE_MAP = {};

    function showError(e) {
      const el = document.createElement('div');
      el.className = 'fixed bottom-4 right-4 z-50 max-w-md bg-red-600 text-white text-sm rounded-lg shadow px-3 py-2';
      el.textContent = 'Erreur: ' + (e && e.message ? e.message : e);
      document.body.appendChild(el);
    }
    async function loadCSV() {
      const res = await fetch(CSV_URL, { cache: 'no-store' });
      if (!res.ok) throw new Error(`Échec de chargement CSV: ${res.status}`);
      const csvText = await res.text();
      return new Promise((resolve) => {
        Papa.parse(csvText, {
          header: true,
          skipEmptyLines: true,
          transformHeader: h => h,
          complete: (results) => resolve(results.data)
        });
      });
    }
    function collectSchemaWarnings(rows) { /* unchanged */ }
    function ingestRows(rows) { /* unchanged */ }
    function buildFilterOptions(items) { /* unchanged */ }
    function fillSelect(id, values) { /* unchanged */ }
    function matchFilters(item) { /* unchanged */ }
    function renderGrid() { /* unchanged */ }

    function openDetail(item) {
      const panel = document.getElementById('detailPanel');
      const t = document.getElementById('detailTitle');
      const c = document.getElementById('detailContent');
      t.textContent = item.title || item.uid;
      c.innerHTML = '';

      const scrollY = window.scrollY || document.documentElement.scrollTop;
      document.body.dataset.scrollLockY = String(scrollY);
      document.body.style.top = `-${scrollY}px`;
      document.body.classList.add('overflow-hidden','fixed','w-full');

      const meta = document.createElement('div');
      meta.className = 'text-sm text-slate-600';
      meta.textContent = `UID : ${item.uid} · Époque : ${textOrDash(item.epoque)}`;
      c.appendChild(meta);

      if (item.long) {
        const p = document.createElement('p');
        p.className = 'mt-2 text-slate-800';
        p.textContent = item.long;
        c.appendChild(p);
      }
      const extras = Object.entries(item.extra || {}).filter(([,v]) => v);
      if (extras.length) {
        const table = document.createElement('table');
        table.className = 'mt-4 w-full text-sm border border-slate-200 rounded-xl overflow-hidden';
        const tbody = document.createElement('tbody');
        extras.forEach(([k,v]) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td class="bg-slate-50 px-3 py-2 w-40 border-b border-slate-200">${k}</td><td class="px-3 py-2 border-b border-slate-200">${v}</td>`;
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        c.appendChild(table);
      }
      if (item.images && item.images.length) {
        const wrap = document.createElement('div');
        wrap.className = 'mt-4 grid grid-cols-2 md:grid-cols-3 gap-3';
        item.images.forEach((img, idx) => {
          const im = document.createElement('img');
          im.src = drivePreviewUrl(img.id);
          im.alt = img.filename || item.title || item.uid;
          im.className = 'w-full h-48 object-cover rounded cursor-zoom-in';
          im.addEventListener('click', () => openLightbox(item, idx));
          wrap.appendChild(im);
        });
        c.appendChild(wrap);
      }
      panel.classList.remove('hidden');
      history.replaceState(null, '', `#${encodeURIComponent(item.uid)}`);
    }

    document.getElementById('btnCloseDetail').addEventListener('click', () => {
      document.getElementById('detailPanel').classList.add('hidden');
      const y = parseInt(document.body.dataset.scrollLockY || '0', 10);
      document.body.classList.remove('overflow-hidden','fixed','w-full');
      document.body.style.top = '';
      window.scrollTo(0, y);
      history.replaceState(null, '', location.pathname + location.search);
    });

    let LB = { item: null, index: 0 };
    function openLightbox(item, index) { /* unchanged */ }
    function updateLightbox() { /* unchanged */ }
    function closeLightbox() { /* unchanged */ }
    document.getElementById('lbClose').addEventListener('click', closeLightbox);
    document.getElementById('lightbox').addEventListener('click', (e) => { if (e.target.id === 'lightbox') closeLightbox(); });
    document.getElementById('lbPrev').addEventListener('click', () => { /* unchanged */ });
    document.getElementById('lbNext').addEventListener('click', () => { /* unchanged */ });

    ['q','f-utilisation','f-mode','f-epoque','f-style','f-fabrication'].forEach(id => {
      document.getElementById(id).addEventListener('input', renderGrid);
      document.getElementById(id).addEventListener('change', renderGrid);
    });
    document.getElementById('btn-reset').addEventListener('click', () => {
      document.getElementById('q').value = '';
      ['f-utilisation','f-mode','f-epoque','f-style','f-fabrication'].forEach(id => document.getElementById(id).value = '');
      renderGrid();
    });
    document.getElementById('btn-print').addEventListener('click', () => window.print());

    (async function init() {
      const status = document.getElementById('statusLine');
      status.textContent = 'Chargement des données…';
      try {
        const rows = await loadCSV();
        const missing = collectSchemaWarnings(rows);
        const { countRows, items, withImages } = ingestRows(rows);
        buildFilterOptions(items);
        renderGrid();
        status.textContent = `Chargé ${countRows} lignes · Articles: ${items.length} · Avec images: ${withImages}` + (missing.length ? ` · ⚠︎ Champs requis manquants: ${missing.join(', ')}` : '');
        const hash = decodeURIComponent(location.hash.slice(1));
        if (hash) {
          const found = ITEMS.find(it => String(it.uid) === hash);
          if (found) openDetail(found);
        }
      } catch (err) {
        console.error(err);
        showError(err);
        const status = document.getElementById('statusLine');
        status.textContent = 'Erreur lors du chargement des données.';
        document.getElementById('grid').innerHTML = `<div class="col-span-full bg-red-50 border border-red-200 text-red-700 p-4 rounded-xl">${err.message || err}</div>`;
      }
    })();
  </script>
</body>
</html>
